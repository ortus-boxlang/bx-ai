/**
 * Unit tests for BedrockService provider
 */
class extends = "testbox.system.BaseSpec"{
	function run(){
		describe( "BedrockService", () => {
			beforeEach( () => {
				variables.bedrockService = new src.main.bx.models.providers.BedrockService();
			} )

			describe( "Initialization", () => {
				it( "can be instantiated", () => {
					expect( bedrockService ).notToBeNull();
					expect( bedrockService.getName() ).toBe( "Bedrock" );
				} )

				it( "has default region of us-east-1", () => {
					expect( bedrockService.getRegion() ).toBe( "us-east-1" );
				} )

				it( "has default model of claude-3-sonnet", () => {
					var params = bedrockService.getParams();
					expect( params.model ).toBe( "anthropic.claude-3-sonnet-20240229-v1:0" );
				} )
			} )

			describe( "Configuration", () => {
				it( "can configure with a struct of settings", () => {
					bedrockService.configure( {
						"region"             : "eu-west-2",
						"awsAccessKeyId"     : "test-key",
						"awsSecretAccessKey" : "test-secret",
						"modelId"            : "anthropic.claude-3-haiku-20240307-v1:0"
					} );

					expect( bedrockService.getRegion() ).toBe( "eu-west-2" );
					expect( bedrockService.getAwsAccessKeyId() ).toBe( "test-key" );
					expect( bedrockService.getAwsSecretAccessKey() ).toBe( "test-secret" );
					expect( bedrockService.getModelId() ).toBe( "anthropic.claude-3-haiku-20240307-v1:0" );
				} )

				it( "can configure with a simple model ID string for compatibility", () => {
					bedrockService.configure( "meta.llama3-70b-instruct-v1:0" );
					expect( bedrockService.getModelId() ).toBe( "meta.llama3-70b-instruct-v1:0" );
				} )

				it( "can configure session token for temporary credentials", () => {
					bedrockService.configure( {
						"region"             : "us-west-2",
						"awsAccessKeyId"     : "temp-key",
						"awsSecretAccessKey" : "temp-secret",
						"awsSessionToken"    : "temp-token"
					} );

					expect( bedrockService.getAwsSessionToken() ).toBe( "temp-token" );
				} )

				it( "returns itself for fluent configuration", () => {
					var result = bedrockService.configure( { "region" : "ap-southeast-1" } );
					expect( result ).toBe( bedrockService );
				} )
			} )

			describe( "Model Family Detection", () => {
				it( "detects Claude models correctly", () => {
					var testCases = [
						"anthropic.claude-3-sonnet-20240229-v1:0",
						"anthropic.claude-3-haiku-20240307-v1:0",
						"anthropic.claude-instant-v1",
						"anthropic.claude-v2:1"
					];

					for ( var modelId in testCases ) {
						var family = invokePrivateMethod(
							bedrockService,
							"detectModelFamily",
							{ modelId : modelId }
						);
						expect( family ).toBe( "claude", "Failed for model: #modelId#" );
					}
				} )

				it( "detects Titan models correctly", () => {
					var testCases = [
						"amazon.titan-text-express-v1",
						"amazon.titan-text-lite-v1",
						"amazon.titan-embed-text-v1"
					];

					for ( var modelId in testCases ) {
						var family = invokePrivateMethod(
							bedrockService,
							"detectModelFamily",
							{ modelId : modelId }
						);
						expect( family ).toBe( "titan", "Failed for model: #modelId#" );
					}
				} )

				it( "detects Llama models correctly", () => {
					var testCases = [
						"meta.llama3-70b-instruct-v1:0",
						"meta.llama2-70b-chat-v1"
					];

					for ( var modelId in testCases ) {
						var family = invokePrivateMethod(
							bedrockService,
							"detectModelFamily",
							{ modelId : modelId }
						);
						expect( family ).toBe( "llama", "Failed for model: #modelId#" );
					}
				} )

				it( "detects Mistral models correctly", () => {
					var testCases = [
						"mistral.mistral-7b-instruct-v0:2",
						"mistral.mixtral-8x7b-instruct-v0:1"
					];

					for ( var modelId in testCases ) {
						var family = invokePrivateMethod(
							bedrockService,
							"detectModelFamily",
							{ modelId : modelId }
						);
						expect( family ).toBe( "mistral", "Failed for model: #modelId#" );
					}
				} )

				it( "returns unknown for unrecognized models", () => {
					var family = invokePrivateMethod(
						bedrockService,
						"detectModelFamily",
						{ modelId : "some.unknown-model-v1" }
					);
					expect( family ).toBe( "unknown" );
				} )
			} )

			describe( "Request Transformation - Claude", () => {
				it( "transforms messages to Claude format with anthropic_version", () => {
					var messages = [ { "role" : "user", "content" : "Hello!" } ];
					var params   = { "max_tokens" : 1024 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForClaude",
						{ messages : messages, params : params }
					);

					expect( result ).toBeStruct();
					expect( result.anthropic_version ).toBe( "bedrock-2023-05-31" );
					expect( result.max_tokens ).toBe( 1024 );
					expect( result.messages ).toBeArray();
					expect( result.messages.len() ).toBe( 1 );
					expect( result.messages[ 1 ].role ).toBe( "user" );
					expect( result.messages[ 1 ].content ).toBe( "Hello!" );
				} )

				it( "extracts system message to top level", () => {
					var messages = [
						{
							"role"    : "system",
							"content" : "You are a helpful assistant."
						},
						{ "role" : "user", "content" : "Hello!" }
					];
					var params = { "max_tokens" : 1024 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForClaude",
						{ messages : messages, params : params }
					);

					expect( result.system ).toBe( "You are a helpful assistant." );
					expect( result.messages.len() ).toBe( 1 );
					expect( result.messages[ 1 ].role ).toBe( "user" );
				} )

				it( "includes temperature when provided", () => {
					var messages = [ { "role" : "user", "content" : "Test" } ];
					var params   = { "max_tokens" : 1024, "temperature" : 0.5 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForClaude",
						{ messages : messages, params : params }
					);

					expect( result.temperature ).toBe( 0.5 );
				} )
			} )

			describe( "Request Transformation - Titan", () => {
				it( "transforms messages to Titan inputText format", () => {
					var messages = [
						{ "role" : "system", "content" : "Be helpful." },
						{ "role" : "user", "content" : "What is 2+2?" }
					];
					var params = { "max_tokens" : 512 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForTitan",
						{ messages : messages, params : params }
					);

					expect( result ).toBeStruct();
					expect( result.keyExists( "inputText" ) ).toBeTrue();
					expect( result.inputText ).toContain( "System: Be helpful." );
					expect( result.inputText ).toContain( "User: What is 2+2?" );
					expect( result.inputText ).toMatch( "Assistant:$" );
					expect( result.textGenerationConfig.maxTokenCount ).toBe( 512 );
				} )
			} )

			describe( "Request Transformation - Llama", () => {
				it( "transforms messages to Llama prompt format", () => {
					var messages = [
						{ "role" : "system", "content" : "You are helpful." },
						{ "role" : "user", "content" : "Hello" }
					];
					var params = { "max_tokens" : 2048 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForLlama",
						{ messages : messages, params : params }
					);

					expect( result ).toBeStruct();
					expect( result.keyExists( "prompt" ) ).toBeTrue();
					expect( result.prompt ).toContain( "<<SYS>>" );
					expect( result.prompt ).toContain( "You are helpful." );
					expect( result.prompt ).toContain( "[INST]" );
					expect( result.prompt ).toContain( "Hello" );
					expect( result.max_gen_len ).toBe( 2048 );
				} )
			} )

			describe( "Request Transformation - Mistral", () => {
				it( "transforms messages to Mistral prompt format", () => {
					var messages = [ { "role" : "user", "content" : "Hello" } ];
					var params   = { "max_tokens" : 1024 };

					var result = invokePrivateMethod(
						bedrockService,
						"transformRequestForMistral",
						{ messages : messages, params : params }
					);

					expect( result ).toBeStruct();
					expect( result.keyExists( "prompt" ) ).toBeTrue();
					expect( result.prompt ).toContain( "[INST]" );
					expect( result.prompt ).toContain( "Hello" );
					expect( result.max_tokens ).toBe( 1024 );
				} )
			} )

			describe( "Response Transformation - Claude", () => {
				it( "transforms Claude response to OpenAI format", () => {
					var claudeResponse = {
						"content"     : [ { "type" : "text", "text" : "Hello! How can I help?" } ],
						"stop_reason" : "end_turn",
						"usage"       : { "input_tokens" : 10, "output_tokens" : 8 }
					};

					var result = invokePrivateMethod(
						bedrockService,
						"transformResponseFromClaude",
						{
							response : claudeResponse,
							modelId  : "anthropic.claude-3-sonnet"
						}
					);

					expect( result ).toBeStruct();
					expect( result.choices ).toBeArray();
					expect( result.choices.len() ).toBe( 1 );
					expect( result.choices[ 1 ].message.role ).toBe( "assistant" );
					expect( result.choices[ 1 ].message.content ).toBe( "Hello! How can I help?" );
					expect( result.choices[ 1 ].finish_reason ).toBe( "end_turn" );
					expect( result.usage.prompt_tokens ).toBe( 10 );
					expect( result.usage.completion_tokens ).toBe( 8 );
					expect( result.usage.total_tokens ).toBe( 18 );
					expect( result.model ).toBe( "anthropic.claude-3-sonnet" );
				} )
			} )

			describe( "Response Transformation - Titan", () => {
				it( "transforms Titan response to OpenAI format", () => {
					var titanResponse = {
						"inputTextTokenCount" : 15,
						"results"             : [ { "outputText" : "The answer is 4.", "tokenCount" : 5 } ]
					};

					var result = invokePrivateMethod(
						bedrockService,
						"transformResponseFromTitan",
						{
							response : titanResponse,
							modelId  : "amazon.titan-text-express-v1"
						}
					);

					expect( result.choices[ 1 ].message.content ).toBe( "The answer is 4." );
					expect( result.usage.prompt_tokens ).toBe( 15 );
					expect( result.usage.completion_tokens ).toBe( 5 );
				} )
			} )

			describe( "Response Transformation - Llama", () => {
				it( "transforms Llama response to OpenAI format", () => {
					var llamaResponse = {
						"generation"             : "Here is my response.",
						"stop_reason"            : "stop",
						"prompt_token_count"     : 20,
						"generation_token_count" : 5
					};

					var result = invokePrivateMethod(
						bedrockService,
						"transformResponseFromLlama",
						{ response : llamaResponse, modelId : "meta.llama3-70b" }
					);

					expect( result.choices[ 1 ].message.content ).toBe( "Here is my response." );
					expect( result.usage.prompt_tokens ).toBe( 20 );
					expect( result.usage.completion_tokens ).toBe( 5 );
				} )
			} )

			describe( "Response Transformation - Mistral", () => {
				it( "transforms Mistral response to OpenAI format", () => {
					var mistralResponse = {
						"outputs" : [
							{
								"text"        : "Mistral response here.",
								"stop_reason" : "stop"
							}
						]
					};

					var result = invokePrivateMethod(
						bedrockService,
						"transformResponseFromMistral",
						{
							response : mistralResponse,
							modelId  : "mistral.mistral-7b"
						}
					);

					expect( result.choices[ 1 ].message.content ).toBe( "Mistral response here." );
				} )
			} )

			describe( "Endpoint Generation", () => {
				it( "generates correct Bedrock endpoint URL", () => {
					bedrockService.configure( { "region" : "eu-west-2" } );

					var endpoint = invokePrivateMethod(
						bedrockService,
						"getBedrockEndpoint",
						{ modelIdOrArn : "anthropic.claude-3-sonnet-20240229-v1:0" }
					);

					expect( endpoint ).toBe( "https://bedrock-runtime.eu-west-2.amazonaws.com/model/anthropic.claude-3-sonnet-20240229-v1:0/invoke" );
				} )

				it( "generates correct host for region", () => {
					bedrockService.configure( { "region" : "us-west-2" } );

					var host = invokePrivateMethod( bedrockService, "getBedrockHost", {} );

					expect( host ).toBe( "bedrock-runtime.us-west-2.amazonaws.com" );
				} )

				it( "generates correct path for model", () => {
					var path = invokePrivateMethod(
						bedrockService,
						"getBedrockPath",
						{ modelIdOrArn : "amazon.titan-text-express-v1" }
					);

					expect( path ).toBe( "/model/amazon.titan-text-express-v1/invoke" );
				} )
			} )

			describe( "Inference Profile ARN Support", () => {
				it( "detects inference profile ARNs correctly", () => {
					var testArn = "arn:aws:bedrock:us-east-1:123456789012:inference-profile/my-profile";
					var result  = invokePrivateMethod(
						bedrockService,
						"isInferenceProfileArn",
						{ arnOrId : testArn }
					);
					expect( result ).toBeTrue();
				} )

				it( "returns false for regular model IDs", () => {
					var testCases = [
						"anthropic.claude-3-sonnet-20240229-v1:0",
						"amazon.titan-text-express-v1",
						"meta.llama3-70b-instruct-v1:0"
					];

					for ( var modelId in testCases ) {
						var result = invokePrivateMethod(
							bedrockService,
							"isInferenceProfileArn",
							{ arnOrId : modelId }
						);
						expect( result ).toBeFalse( "Should return false for: #modelId#" );
					}
				} )

				it( "generates correct path for inference profile ARN", () => {
					var testArn = "arn:aws:bedrock:us-east-1:123456789012:inference-profile/my-profile";
					var path    = invokePrivateMethod(
						bedrockService,
						"getBedrockPath",
						{ modelIdOrArn : testArn }
					);

					expect( path ).toContain( "/application-inference-profile/" );
					expect( path ).toContain( "/invoke" );
					expect( path ).notToContain( "/model/" );
				} )

				it( "generates correct streaming path for inference profile ARN", () => {
					var testArn = "arn:aws:bedrock:us-east-1:123456789012:inference-profile/my-profile";
					var path    = invokePrivateMethod(
						bedrockService,
						"getBedrockStreamPath",
						{ modelIdOrArn : testArn }
					);

					expect( path ).toContain( "/application-inference-profile/" );
					expect( path ).toContain( "/invoke-with-response-stream" );
					expect( path ).notToContain( "/model/" );
				} )

				it( "preserves standard model path when not using inference profile", () => {
					var modelId = "anthropic.claude-3-sonnet-20240229-v1:0";
					var path    = invokePrivateMethod(
						bedrockService,
						"getBedrockPath",
						{ modelIdOrArn : modelId }
					);

					expect( path ).toBe( "/model/anthropic.claude-3-sonnet-20240229-v1:0/invoke" );
				} )
			} )

			describe( "Streaming", () => {
				it( "has chatStream method implemented", () => {
					// Verify chatStream method exists and is callable
					expect( bedrockService ).toHaveKey( "chatStream" );
				} )
			} )
		} )
	}

	/**
	 * Helper to invoke private methods for testing
	 */
	private function invokePrivateMethod(
		required any target,
		required string methodName,
		struct args = {}
	){
		var method = arguments.target[ arguments.methodName ];
		return method( argumentCollection = arguments.args );
	}

	/**
	 * Create a mock object
	 */
	private function createMock( required string className ){
		return getMockBox().createMock( arguments.className );
	}
}
