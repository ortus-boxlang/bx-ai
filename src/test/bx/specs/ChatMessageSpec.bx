class extends="testbox.system.BaseSpec"{

	function run(){

		describe( "Chat Messages", () => {

			beforeEach( () => {
				variables.chatMessage = new src.main.bx.models.ChatMessage()
				variables.chatMessage.clear()
			} )

			it( "can create a chat message", () => {
				expect( chatMessage ).notToBeNull()
				expect( chatMessage.count() ).toBe( 0 )
				expect( chatMessage.getSystemMessage() ).toBe( "" )
			} )

			it( "can add a system message using different approaches" , () => {
				chatMessage.add( { content: "Hello", role: "system" } )
				expect( chatMessage.count() ).toBe( 1 )
				expect( chatMessage.hasSystemMessage() ).toBeTrue()

				chatMessage.clear()
				chatMessage.system( "hello" )
				expect( chatMessage.count() ).toBe( 1 )
				expect( chatMessage.hasSystemMessage() ).toBeTrue()
				expect( chatMessage.getSystemMessage() ).toBe( "hello" )

				// If you try again, it should not allow ignore it if it's the same content.
				chatMessage.system( "hello" )
				expect( chatMessage.count() ).toBe( 1 )
				expect( chatMessage.hasSystemMessage() ).toBeTrue()

				// Try with a different message
				chatMessage.system( "goodbye" )
				expect( chatMessage.count() ).toBe( 1 )
				expect( chatMessage.hasSystemMessage() ).toBeTrue()
				expect( chatMessage.getSystemMessage() ).toBe( "goodbye" )
			} )

			it( "can serialize to JSON using toJson()", () => {
				chatMessage.add( "Hello world" )
				chatMessage.add( { role: "assistant", content: "Hi there!" } )
				
				var json = chatMessage.toJson()
				
				expect( json ).notToBeNull()
				expect( json ).toBeString()
				expect( json.len() ).toBeGT( 0 )
				
				// Verify JSON contains expected data
				var data = jsonDeserialize( json )
				expect( data ).toHaveKey( "messages" )
				expect( data.messages ).toBeArray()
				expect( data.messages.len() ).toBe( 2 )
			} )

			it( "can deserialize from JSON using fromJson()", () => {
				var json = '{"messages":[{"role":"user","content":"Test message"}],"bindings":{}}'
				var restored = new src.main.bx.models.ChatMessage().fromJson( json )
				
				expect( restored ).notToBeNull()
				expect( restored.count() ).toBe( 1 )
			} )

			it( "can round-trip serialize and deserialize messages", () => {
				chatMessage.add( "First message" )
				chatMessage.add( { role: "assistant", content: "Second message" } )
				chatMessage.add( { role: "system", content: "System prompt" } )
				
				var json = chatMessage.toJson()
				var restored = new src.main.bx.models.ChatMessage().fromJson( json )
				
				expect( restored.count() ).toBe( 3 )
				expect( restored.hasSystemMessage() ).toBeTrue()
				expect( restored.getSystemMessage() ).toBe( "System prompt" )
			} )

			it( "can serialize and deserialize bindings", () => {
				chatMessage.add( "Hello {name}" )
				chatMessage.bind( { name: "World" } )
				
				var json = chatMessage.toJson()
				var restored = new src.main.bx.models.ChatMessage().fromJson( json )
				
				expect( restored.count() ).toBe( 1 )
				var rendered = restored.render()
				expect( rendered[ 1 ].content ).toBe( "Hello World" )
			} )

			it( "can serialize empty messages", () => {
				var json = chatMessage.toJson()
				var data = jsonDeserialize( json )
				
				expect( data.messages ).toBeArray()
				expect( data.messages.len() ).toBe( 0 )
				expect( data.bindings ).toBeStruct()
			} )

			it( "can deserialize empty JSON", () => {
				var json = '{"messages":[],"bindings":{}}'
				var restored = new src.main.bx.models.ChatMessage().fromJson( json )
				
				expect( restored.count() ).toBe( 0 )
			} )

			it( "can handle complex message structures in JSON", () => {
				chatMessage.add( {
					role: "user",
					content: "Test with special chars: \"quotes\", 'apostrophes', and \nnewlines"
				} )
				
				var json = chatMessage.toJson()
				var restored = new src.main.bx.models.ChatMessage().fromJson( json )
				
				expect( restored.count() ).toBe( 1 )
			} )

		} )

	}

}
