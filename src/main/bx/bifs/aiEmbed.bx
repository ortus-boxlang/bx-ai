/**
 * [BoxLang]
 *
 * Copyright [2023] [Ortus Solutions, Corp]
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 * ----------------------------------------------------------------------------------
 * Generate embeddings for the given input text or array of texts using an AI provider
 *
 * @example
 * ```
 * // Single text embedding
 * embedding = aiEmbed( "Hello World" )
 * println( embedding.data.first().embedding )
 *
 * // Batch embeddings
 * embeddings = aiEmbed( ["Hello", "World", "BoxLang"] )
 * println( embeddings.data.map( d => d.embedding ) )
 *
 * // With specific provider and model
 * embedding = aiEmbed(
 *     input: "Hello World",
 *     params: { model: "text-embedding-3-large" },
 *     options: { provider: "openai" }
 * )
 *
 * // Get just the embeddings array
 * embeddings = aiEmbed(
 *     input: "Hello",
 *     options: { returnFormat: "embeddings" }
 * )
 * ```
 */
@BoxBIF
class {

	static MODULE_SETTINGS = getModuleInfo( "bxai" ).settings;

	/**
	 * Generate embeddings for the given input text(s)
	 *
	 * @input The input text or array of texts to generate embeddings for
	 * @params A set of request params to pass to the provider (e.g., model, encoding_format)
	 * @options A set of request options (e.g., provider, apiKey, returnFormat, timeout, logResponse, logResponseToConsole, logRequest, logRequestToConsole)
	 *
	 * @return The embeddings response from the provider. Format depends on returnFormat option:
	 *         - "raw" (default): Full API response with metadata
	 *         - "embeddings": Array of embedding vectors only
	 *         - "first": Single embedding vector (first item if batch)
	 */
	function invoke(
		required any input,
		struct params = {},
		struct options = {}
	){
		// Merge options
		arguments.options.append( static.MODULE_SETTINGS, false );

		// Create the embedding request
		var embeddingRequest = new bxModules.bxai.models.requests.AiEmbeddingRequest(
			input   = arguments.input,
			params  = arguments.params,
			options = arguments.options
		);

		// Get the service
		var service = aiService( arguments.options?.provider, arguments.options );

		// Announce the embedding request
		BoxAnnounce( "beforeAIEmbed", { embeddingRequest: embeddingRequest, service: service, auditMetadata: embeddingRequest.getAuditMetadata() } );

		// Generate embeddings
		var result = service.embeddings( embeddingRequest );

		// Announce the response
		BoxAnnounce( "afterAIEmbed", { embeddingRequest: embeddingRequest, service: service, result: result } );

		return result;
	}

}
