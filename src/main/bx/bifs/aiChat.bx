/**
 * [BoxLang]
 *
 * Copyright [2023] [Ortus Solutions, Corp]
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 * ----------------------------------------------------------------------------------
 * AI
 */
@BoxBIF
class {

	static final VALID_RESPONSE_FORMATS = [ "single", "all", "raw", "json", "xml" ]
	static final DEFAULT_OPTIONS = {
		returnFormat : "single",  // aiChat() defaults to single for convenience
		timeout : 30,
		logResponse : false,
		logRequest : false
	}
	static MODULE_SETTINGS = getModuleInfo( "bxai" ).settings;

	/**
	 * Inject the following references into the class
	 * - moduleRecord : The ModuleRecord instance
	 * - boxRuntime : The BoxRuntime instance
	 * - interceptorService : The BoxLang InterceptorService
	 * - log : A logger for the module config itself
	 */

    /**
     * Initiate an AI chat against the default or custom AI Provider.
	 * <p>
	 * The messages can be a simple string, a struct representing a message or an array of messages or an actual AiMessage object
	 * <p>
	 * The <code>params</code> are a struct of request params to pass to the provider for the model request according to the provider: Ex	{ temperature: 0.5, max_tokens: 100, model: "gpt-3.5-turbo" }.
	 * You can also use default params in your Module configuration.
	 * <p>
	 * The <code>options</code> are a struct of request options to pass to the service for the model request. Available options are:
	 * <ul>
	 * <li>provider:string - The provider to use for the chat. If not passed, we will use the default from the configuration.</li>
	 * <li>apiKey:string - The API Key for the provider. If not passed, we will use the default from the configuration.</li>
	 * <li>timeout:numeric - The timeout in seconds for the request. The default is 30 seconds</li>
	 * <li>logResponse:boolean - Log the response into the ai.log. The default is false</li>
	 * <li>logRequest:boolean - Log the request into the ai.log. The default is false</li>
	 * <li>returnFormat:string - The return format of the response. The default is "single" message. Valid formats are: "single", "all", "raw", "json", "xml"</li>
	 * <li>context:struct - A context struct for injecting security, RAG, or other contextual data into the request</li>
	 * </ul>
	 *
	 * @messages The messages to pass into the required model. This depends on the provider. It can be a simple string, a struct representing a message or an array of messages or an actual AiMessage object
	 * @params A struct of request params to pass to the provider for the model request: Ex	{ temperature: 0.5, max_tokens: 100, model: "gpt-3.5-turbo" }
	 * @options A struct of request options to pass to the provider for the model request. Available options are: { provider:string, apiKey:string, returnFormat:string timeout:numeric, logResponse:boolean, logRequest:boolean, context:struct }
	 *
	 * @throw InvalidArgument if the return format is not valid
     */
    function invoke(
		required any messages,
		struct params = {},
		struct options = {}
	) {
		// Incorporate default params with no override
		arguments.params.append( moduleRecord.settings.defaultParams, false );
		arguments.options.append( static.DEFAULT_OPTIONS, false );
		arguments.options.append( static.MODULE_SETTINGS, false );

		// Validate returnFormat only if it's a simple string value
		// Complex values (class instances, structs, arrays) are for structured output
		if( isSimpleValue( arguments.options.returnFormat ) && !static.VALID_RESPONSE_FORMATS.contains( arguments.options.returnFormat ) ){
			throw(
				type : "InvalidArgument",
				message : "Invalid return format [#arguments.options.returnFormat#]. Valid formats are: #static.VALID_RESPONSE_FORMATS.toList()# or a class/struct/array for structured output"
			);
		}

		// Build out a chat request
		var oRequest = new bxModules.bxai.models.requests.AiRequest(
			aiMessage( arguments.messages ),
			arguments.params,
			arguments.options
		);

		// Get the provider and chat with it
		return aiService( provider: arguments.options?.provider ).invoke( oRequest );
	}

}
