// rag-pipeline.bxs
/**
 * RAG (Retrieval Augmented Generation) Pipeline Demo
 * Combine knowledge retrieval with AI generation
 */

println( "=== RAG Pipeline Demo ===" )
println()

// Mock knowledge base
knowledgeBase = [
    { topic: "BoxLang", content: "BoxLang is a modern dynamic JVM language with CFML compatibility and Java interop" },
    { topic: "AI Module", content: "The BoxLang AI module provides unified access to multiple AI providers like OpenAI, Claude, and Gemini" },
    { topic: "Pipelines", content: "Pipelines chain AI operations together for complex workflows" },
    { topic: "Agents", content: "Agents are autonomous AI systems that can use tools and make decisions" }
]

// Step 1: Retrieval - find relevant knowledge
retrievalStep = aiTransform( ( query ) => {
    // Search knowledge base (simple keyword match)
    relevant = knowledgeBase.filter( doc => 
        doc.topic.findNoCase( query ) || doc.content.findNoCase( query )
    )
    
    if ( relevant.len() == 0 ) {
        return "No relevant information found in knowledge base"
    }
    
    // Return concatenated relevant content
    return relevant.map( doc => doc.content ).toList( " " )
} )

// Step 2: Augmentation - combine with query
augmentationStep = aiTransform( ( data ) => {
    // Data is a struct with context and query
    return "Context: #data.context#

Question: #data.query#

Use the context to answer the question accurately."
} )

// Build RAG pipeline
ragPipeline = aiTransform( ( query ) => {
    // Retrieve context
    context = retrievalStep.run( query )
    
    return {
        query: query,
        context: context
    }
} )
    .to( augmentationStep )
    .to( aiModel( "gpt-4o-mini" ) )

// Test queries
queries = [
    "What is BoxLang?",
    "Tell me about AI Agents",
    "How do I use the AI module?"
]

queries.each( query => {
    println( "-".repeat( 70 ) )
    println( "Query: #query#" )
    println()
    
    answer = ragPipeline.run( query )
    
    println( "Answer: #answer#" )
    println()
} )

println( "ðŸ’¡ RAG Pipeline Pattern:" )
println( "1. Retrieval - Search knowledge base" )
println( "2. Augmentation - Add context to query" )
println( "3. Generation - AI creates answer from context" )
println()
println( "Benefits:" )
println( "- Grounded responses (less hallucination)" )
println( "- Use private/recent knowledge" )
println( "- Cite sources" )
println( "- Update knowledge without retraining" )
