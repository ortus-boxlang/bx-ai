// model-introspection.bxs
/**
 * Model Introspection Demo
 * Inspecting and debugging model configurations
 */

println( "=== Model Introspection Demo ===" )
println()

// Create models with different configurations
println( "Example 1: Basic Model Config" )
println( "-".repeat( 70 ) )

basicModel = aiModel( "openai" )
    .withParams({
        model: "gpt-4o-mini",
        temperature: 0.7
    })
    .withName( "BasicModel" )

config = basicModel.getConfig()
println( "Model Configuration:" )
println( "  Name: #config.name#" )
println( "  Provider: #config.provider#" )
println( "  Tools: #config.toolCount#" )
println( "  Params:" )
println( "    - model: #config.params.model#" )
println( "    - temperature: #config.params.temperature#" )
println()

// Example 2: Model with tools
println( "Example 2: Model with Tools" )
println( "-".repeat( 70 ) )

calculatorTool = aiTool()
    .setName( "calculate" )
    .setDescription( "Perform math calculations" )
    .setHandler( args => evaluate( args.expression ) )

searchTool = aiTool()
    .setName( "search" )
    .setDescription( "Search for information" )
    .setHandler( args => "Search result for: #args.query#" )

tooledModel = aiModel( "openai" )
    .withName( "TooledModel" )
    .bindTools( [ calculatorTool, searchTool ] )

config = tooledModel.getConfig()
println( "Tooled Model Configuration:" )
println( "  Name: #config.name#" )
println( "  Provider: #config.provider#" )
println( "  Tool Count: #config.toolCount#" )
println()

// Example 3: Configuration comparison
println( "Example 3: Comparing Models" )
println( "-".repeat( 70 ) )

models = [
    aiModel( "openai" )
        .withParams({ temperature: 0.2, model: "gpt-4o-mini" })
        .withName( "Factual" ),

    aiModel( "openai" )
        .withParams({ temperature: 0.9, model: "gpt-4o-mini" })
        .withName( "Creative" ),

    aiModel( "openai" )
        .withParams({ temperature: 0.5, model: "gpt-4o-mini" })
        .withName( "Balanced" )
]

println( "Model Comparison:" )
println()
println( "Name".ljust( 15 ) & "Temperature".ljust( 15 ) & "Provider" )
println( "-".repeat( 45 ) )

models.each( m => {
    config = m.getConfig()
    println(
        config.name.ljust( 15 ) &
        config.params.temperature.toString().ljust( 15 ) &
        config.provider
    )
})
println()

// Example 4: Configuration validation
println( "Example 4: Configuration Validation" )
println( "-".repeat( 70 ) )

function validateModelConfig( required model ) {
    config = model.getConfig()
    issues = []

    // Check temperature
    if ( structKeyExists( config.params, "temperature" ) ) {
        temp = config.params.temperature
        if ( temp < 0 || temp > 2 ) {
            issues.append( "Temperature #temp# out of range (0-2)" )
        }
    }

    // Check model name
    if ( !len( config.name ) ) {
        issues.append( "Model has no name" )
    }

    // Check provider
    validProviders = [ "OpenAI", "Claude", "Gemini", "Ollama" ]
    if ( !validProviders.findNoCase( config.provider ) ) {
        issues.append( "Unknown provider: #config.provider#" )
    }

    return {
        valid: issues.len() == 0,
        issues: issues,
        config: config
    }
}

// Validate models
testModels = [
    aiModel( "openai" ).withParams({ temperature: 0.5 }),
    aiModel( "openai" ).withParams({ temperature: 2.5 }),  // Invalid!
    aiModel( "openai" ).withName( "" )  // Invalid!
]

testModels.each( ( model, index ) => {
    result = validateModelConfig( model )

    println( "Model #index#:" )
    if ( result.valid ) {
        println( "  âœ“ Valid configuration" )
    } else {
        println( "  âœ— Invalid configuration" )
        result.issues.each( issue => {
            println( "    - #issue#" )
        })
    }
    println()
})

// Example 5: Configuration for debugging
println( "Example 5: Debug Logging" )
println( "-".repeat( 70 ) )

function logModelUsage( required model, required input ) {
    config = model.getConfig()

    println( "[DEBUG] Model Execution" )
    println( "  Model: #config.name#" )
    println( "  Provider: #config.provider#" )
    println( "  Tools: #config.toolCount#" )

    if ( structKeyExists( config.params, "temperature" ) ) {
        println( "  Temperature: #config.params.temperature#" )
    }

    if ( structKeyExists( config.params, "max_tokens" ) ) {
        println( "  Max Tokens: #config.params.max_tokens#" )
    }

    println( "  Input: #input.left( 50 )#..." )
    println()
}

debugModel = aiModel( "openai" )
    .withParams({ temperature: 0.7, max_tokens: 100 })
    .withName( "DebugModel" )

logModelUsage( debugModel, "What is BoxLang?" )

// Example 6: Export/Import simulation
println( "Example 6: Configuration Export" )
println( "-".repeat( 70 ) )

exportModel = aiModel( "openai" )
    .withParams({
        model: "gpt-4o-mini",
        temperature: 0.8,
        max_tokens: 500
    })
    .withName( "ExportedModel" )

config = exportModel.getConfig()
configJSON = serializeJSON( config, true )

println( "Exported Configuration:" )
println( configJSON )
println()

println( "ðŸ’¡ Model Introspection Benefits:" )
println( "- Debug model configurations" )
println( "- Validate settings before execution" )
println( "- Compare different models" )
println( "- Log execution details" )
println( "- Export/import configurations" )
println( "- Monitor model usage" )
