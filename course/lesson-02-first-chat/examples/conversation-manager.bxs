// conversation-manager.bxs
/**
 * Reusable Conversation Manager
 * A class-based approach to managing conversations
 */

/**
 * ConversationManager - Maintains conversation history
 */
class {
    property name="messages" type="array";
    property name="systemPrompt" type="string";
    
    /**
     * Initialize the conversation
     */
    function init( systemPrompt = "" ) {
        variables.messages = []
        variables.systemPrompt = arguments.systemPrompt
        
        if ( len( variables.systemPrompt ) ) {
            variables.messages.append( aiMessage().system( variables.systemPrompt ) )
        }
        
        return this
    }
    
    /**
     * Ask a question
     */
    function ask( question ) {
        // Add user message
        variables.messages.append( aiMessage().user( arguments.question ) )
        
        // Get AI response
        answer = aiChat( variables.messages )
        
        // Add assistant response to history
        variables.messages.append( aiMessage().assistant( answer ) )
        
        return answer
    }
    
    /**
     * Get conversation history
     */
    function getHistory() {
        return variables.messages
    }
    
    /**
     * Get conversation length
     */
    function length() {
        return variables.messages.len()
    }
    
    /**
     * Reset conversation
     */
    function reset() {
        variables.messages = []
        if ( len( variables.systemPrompt ) ) {
            variables.messages.append( aiMessage().system( variables.systemPrompt ) )
        }
        return this
    }
    
    /**
     * Export conversation as JSON
     */
    function export() {
        return serializeJSON( variables.messages, true )
    }
    
    /**
     * Display conversation
     */
    function display() {
        variables.messages.each( msg => {
            role = msg.role.uCase()
            content = msg.content
            
            println( "#role#: #content#" )
            println()
        } )
    }
}

// ===== DEMO USAGE =====

println( "=== Conversation Manager Demo ===" )
println()

// Example 1: Math Tutor
println( "Example 1: Math Tutor Conversation" )
println( "-".repeat( 60 ) )

mathTutor = new ConversationManager( "You are a patient math tutor for beginners" )

println( "Q1: What is multiplication?" )
answer1 = mathTutor.ask( "What is multiplication?" )
println( "A1: " & answer1 )
println()

println( "Q2: Can you give an example?" )
answer2 = mathTutor.ask( "Can you give an example?" )
println( "A2: " & answer2 )
println()

println( "Q3: What about division?" )
answer3 = mathTutor.ask( "What about division?" )
println( "A3: " & answer3 )
println()

println( "Conversation has #mathTutor.length()# messages" )
println()

// Example 2: Code Reviewer
println( "Example 2: Code Review Conversation" )
println( "-".repeat( 60 ) )

codeReviewer = new ConversationManager(
    "You are a senior code reviewer. Be constructive and specific."
)

code = 'function divide(a, b) { return a / b; }'

println( "Submitting code: #code#" )
review = codeReviewer.ask( "Review this code: " & code )
println( "Review: " & review )
println()

println( "Following up: How would you fix it?" )
fix = codeReviewer.ask( "How would you fix it?" )
println( "Fix: " & fix )
println()

// Example 3: Reset and Reuse
println( "Example 3: Reset and Reuse" )
println( "-".repeat( 60 ) )

chat = new ConversationManager( "You are a friendly assistant" )

println( "First conversation:" )
println( "  " & chat.ask( "What is AI?" ).left( 50 ) & "..." )
println( "  Messages: " & chat.length() )
println()

println( "Resetting..." )
chat.reset()

println( "New conversation:" )
println( "  " & chat.ask( "What is ML?" ).left( 50 ) & "..." )
println( "  Messages: " & chat.length() )
println()

// Example 4: Export Conversation
println( "Example 4: Export Conversation" )
println( "-".repeat( 60 ) )

exported = mathTutor.export()
println( "Exported conversation (JSON):" )
println( exported )
println()

println( "ðŸ’¡ The ConversationManager class:" )
println( "- Encapsulates conversation logic" )
println( "- Maintains message history automatically" )
println( "- Reusable across different AI personalities" )
println( "- Can export/import conversations" )
