// mcp-with-ai-chat.bxs
/**
 * MCP with AI Chat Demo
 * Retrieval Augmented Generation (RAG) pattern
 */

println( "=== MCP + AI Chat Integration ===" )
println()

// Function to ask AI with context from MCP
function askWithContext( required string question ) {
    println( "Question: #arguments.question#" )
    println()
    
    // 1. Search relevant docs via MCP
    println( "  ğŸ” Searching documentation..." )
    mcpClient = MCP( "http://localhost:3000" )
        .withTimeout( 10000 )
    
    searchResult = mcpClient.send( "searchDocs", {
        query: arguments.question,
        limit: 3
    } )
    
    if ( !searchResult.getSuccess() ) {
        println( "  âš ï¸  MCP search failed, asking AI without context" )
        return aiChat( arguments.question )
    }
    
    // 2. Extract relevant content
    println( "  ğŸ“š Building context from search results..." )
    docs = searchResult.getData().results
    context = ""
    
    docs.each( doc => {
        resourceContent = mcpClient.readResource( doc.uri )
        if ( resourceContent.getSuccess() ) {
            context &= "### #doc.title#" & chr(10)
            context &= resourceContent.getData().content & chr(10) & chr(10)
        }
    } )
    
    // 3. Ask AI with context
    println( "  ğŸ¤– Asking AI with context..." )
    println()
    
    answer = aiChat( [
        aiMessage().system( "You are a helpful documentation assistant." ),
        aiMessage().system( "Answer using this context:#chr(10)##context#" ),
        aiMessage().user( arguments.question )
    ] )
    
    return answer
}

// Test questions
questions = [
    "How do I install BoxLang?",
    "What are the AI providers supported?",
    "How do I use streaming responses?"
]

questions.each( question => {
    println( "=".repeat( 70 ) )
    
    try {
        answer = askWithContext( question )
        println( "Answer:" )
        println( answer )
        
    } catch( any e ) {
        println( "âŒ Error: #e.message#" )
    }
    
    println()
} )

println( "ğŸ’¡ RAG Pattern Benefits:" )
println( "- AI gets accurate, up-to-date information" )
println( "- Reduces hallucinations" )
println( "- Works with proprietary/internal docs" )
println( "- Combines search with AI reasoning" )
